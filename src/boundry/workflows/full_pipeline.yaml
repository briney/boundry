# Combined pipeline workflow
#
# Idealize -> convergence loop -> beam search. Demonstrates nested,
# composable block structures.
#
# Uses ${output} variable interpolation so the base output directory
# is defined in one place.

workflow_version: 1
input: input.pdb
output: full_pipeline_results
seed: 42

steps:
  - operation: idealize
  - iterate:
      until: "delta({final_energy}) < 0.5"
      max_n: 20
      output: ${output}/converge_cycle_{cycle}.pdb
      steps:
        - operation: relax
          params:
            n_iterations: 1
        - operation: analyze_interface
          params:
            calculate_binding_energy: true
  - beam:
      width: 3
      rounds: 6
      expand: 3
      metric: dG
      direction: min
      output: ${output}/beam_round_{round}_rank_{rank}.pdb
      steps:
        - operation: design
          params:
            n_iterations: 1
        - operation: relax
          params:
            n_iterations: 1
        - operation: analyze_interface
          params:
            calculate_binding_energy: true
